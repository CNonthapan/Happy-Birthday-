<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Happy Birthday!</title>
  <style>
    :root{
      --bg:#091018;
      --panel:#071219;
      --text:#cfe8d9;
      --accent:#7ee787;
      --muted:#6b7880;
      --warn:#f1fa8c;
    }
    html,body{height:100%;margin:0}
    body{
      background:#000;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;
      color:var(--text);
      display:flex;align-items:center;justify-content:center;
      padding:20px;
    }
    .terminal{
      width:min(920px,96%);
      background:var(--panel);
      border-radius:12px;
      box-shadow: 0 10px 30px rgba(3,7,10,0.6);
      padding:20px;
      border:1px solid rgba(255,255,255,0.05);
      min-height:480px;
      overflow-y:auto;
    }
    .controls{display:flex;gap:8px;margin-bottom:14px}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.r{background:#ff5f56}
    .dot.y{background:#ffbd2e}
    .dot.g{background:#27c93f}
    .line{font-size:15px;line-height:1.6;white-space:pre-wrap}
    .prompt{color:var(--muted)}
    .user{color:var(--accent)}
    .cmd{color:var(--text)}
    .result{margin-left:12px;color:var(--text)}
    .cursor{display:inline-block;width:8px;height:16px;background:var(--text);margin-left:6px;animation:blink 1s steps(2) infinite}
    @keyframes blink{50%{opacity:0}}

    .greeting{font-size:18px;margin-top:18px;margin-left:6px;white-space:pre-wrap;max-width:86%;text-align:center}
    .greeting h2{margin:0;color:var(--accent)}
    .greeting-line{margin:8px 0}
    .greeting .footer{margin-top:12px;color:var(--muted)}

    .loading span{display:inline-block;animation:dotBlink 1.2s infinite}
    .loading span:nth-child(2){animation-delay:.2s}
    .loading span:nth-child(3){animation-delay:.4s}
    @keyframes dotBlink{0%,80%,100%{opacity:0}40%{opacity:1}}

    .ascii-art{color:var(--warn);font-size:12px;line-height:1.2;margin:12px 0;white-space:pre}
  </style>
</head>
<body>
  <div class="terminal" id="terminal">
    <div class="controls" aria-hidden="true">
      <div class="dot r"></div>
      <div class="dot y"></div>
      <div class="dot g"></div>
    </div>
    <div id="output"></div>
  </div>

  <script>
    // ASCII cake/art
    const asciiCake = `
██   ██  █████  ██████  ██████  ██    ██     ██████  ██ ██████  ████████ ██   ██ ██████   █████  ██    ██ ██ 
██   ██ ██   ██ ██   ██ ██   ██  ██  ██      ██   ██ ██ ██   ██    ██    ██   ██ ██   ██ ██   ██  ██  ██  ██ 
███████ ███████ ██████  ██████    ████       ██████  ██ ██████     ██    ███████ ██   ██ ███████   ████   ██ 
██   ██ ██   ██ ██      ██         ██        ██   ██ ██ ██   ██    ██    ██   ██ ██   ██ ██   ██    ██       
██   ██ ██   ██ ██      ██         ██        ██████  ██ ██   ██    ██    ██   ██ ██████  ██   ██    ██    ██ 
                                                                                                             
                                                                                                             
`;

    // rotating jokes
    const jokes = [
      "Life may feel NP-hard, but celebrating you is a trivial decision.",
      "Physics says ‘assume ideal conditions’, so I’m assuming you’ll have the perfect time.",
      "If life was a database, your index would always be primary.",
      "You are more reliable than a deterministic algorithm.",
      "Even in a closed system, your energy somehow increases.",
      "May your stack never overflow and your happiness always stay in scope.",
      "The AP Program offers college-level courses and exams that you can take in high school.",
      "If F = ma, then clearly the net force on me is just F = mg",
      "Like AP scores, your awesomeness is reported on a 1–5 scale… but you’re easily a 6.",
      "AP gives students the chance to tackle college-level work while they're still in high school. And through taking AP Exams, students can earn college credit and placement.",
      "If life was an array, you’d definitely be at index 0."
    ];

    // placeholder values; will be replaced from query params
    let NAME = 'RECIPIENT_NAME';
    let AGE = '16';

    // build commands dynamically after reading params
    function buildCommands(){
      return [
        {cmd: 'whoami', res: NAME},
        {cmd: 'uname -a', res: 'birthday-kernel v1.0 (fun-OS)'},
        {cmd: 'ping party.server', res: 'Pinging 127.0.0.1 ... Success'},
        {cmd: 'bg surprises', res: '<span class="loading">.<span>.</span><span>.</span></span>', raw:true},
        {cmd: 'echo $AGE', res: AGE},
        {cmd: 'AGE++', special: 'ageInc'},
        {cmd: 'xxd msg.bin', special: 'hexdump'},
        {cmd: 'cat hbd.txt', res: asciiCake, pre:true},
        {cmd: 'cat message.txt', res: 'final'}
      ];
    }

    const output = document.getElementById('output');

    // typing effect for commands and lines
    function typeWriter(el, text, speed=35, cb){
      let i=0;
      const cursor = document.createElement('span');
      cursor.className = 'cursor';
      el.appendChild(cursor);
      function step(){
        if(i < text.length){
          cursor.insertAdjacentText('beforebegin', text.charAt(i));
          i++;
          setTimeout(step, speed);
        } else {
          cursor.remove();
          if(cb) cb();
        }
      }
      step();
    }

    // scroll helper
    function scrollToBottom(){
      output.parentElement.scrollTop = output.parentElement.scrollHeight;
    }

    // run commands sequentially
    let cmds = [];
    let idx = 0;
    function runNext(){
      if(idx >= cmds.length) return;
      const c = cmds[idx];

      const line = document.createElement('div');
      line.className = 'line';
      const cmdSpan = document.createElement('span');
      cmdSpan.className = 'cmd';
      line.innerHTML = `<span class="prompt">name@happy-birthday</span>:<span class="user">~</span>$ `;
      line.appendChild(cmdSpan);
      output.appendChild(line);
      scrollToBottom();

      typeWriter(cmdSpan, c.cmd, 50, ()=>{
        setTimeout(()=>{
          // special handlers
          if(c.special === 'ageInc'){
            // simulate multiple sub-commands for AGE++
            const before = (typeof AGE === 'number') ? AGE : (parseInt(AGE,10) || 0);
            const after = before + 1;
            const flushLines = [
              `AGE incremented: ${before} → ${after}`,
              'compiling birthday modules...',
              'loading candles...',
              'dispatching party packets...',
              'deploying wishes...',
              'indexing nerdy jokes...',
              'done.'
            ];
            // append flush lines one by one
            flushLines.forEach((t,i2)=>{
              setTimeout(()=>{
                const r = document.createElement('div');
                r.className = 'result';
                r.textContent = '➜ ' + t;
                output.appendChild(r);
                scrollToBottom();
              }, i2 * 450);
            });
            // update AGE variable after flush completes
            setTimeout(()=>{
              AGE = after;
              idx++;
              runNext();
            }, flushLines.length * 450 + 300);
            return;
          }

          if(c.special === 'hexdump'){
            const dump = [
              "69 20 74 68 69 6E 6B 20 75 72 20 72 65 61 6C 6C 79 20 61 77 65 73 6F 6D 65 20 77",
              "65 20 73 68 6F 75 6C 64 20 74 61 6C 6B 20 6D 6F 72 65 20 70 72 6F 62 61 62 6C 79"
            ];
            dump.forEach((line,i2)=>{
              setTimeout(()=>{
                const r = document.createElement('div');
                r.className = 'result';
                r.textContent = line;
                output.appendChild(r);
                scrollToBottom();
              }, i2 * 400);
            });
            setTimeout(()=>{
              idx++;
              runNext();
            }, dump.length * 400 + 300);
            return;
          }

          // final 'cat birthday.txt' trigger
          if(c.res === 'final'){
            // append a small result to show file cat
            const r = document.createElement('div');
            r.className = 'result';
            r.textContent = '➜ Opening birthday.txt';
            output.appendChild(r);
            scrollToBottom();
            setTimeout(()=>{
              showGreeting();
            }, 600);
            return;
          }

          // normal outputs
          const r = document.createElement('div');
          if(c.pre){
            r.className = 'ascii-art';
            r.textContent = c.res;
          } else if(c.raw){
            r.className = 'result';
            r.innerHTML = '➜ ' + c.res;
          } else {
            r.className = 'result';
            r.textContent = '➜ ' + c.res;
          }
          output.appendChild(r);
          scrollToBottom();

          idx++;
          setTimeout(runNext, 900);
        }, 300);
      });
    }

    // greeting that stays visible; header + cycling jokes + sign-off
    let greetingEl = null;
    function showGreeting(){
      // ensure header/footer remain visible
      if(!greetingEl){
        greetingEl = document.createElement('div');
        greetingEl.className = 'greeting';

        const h = document.createElement('h2');
        h.textContent = `Happy Birthday, ${NAME}!`;
        greetingEl.appendChild(h);

        const msg = document.createElement('div');
        msg.className = 'greeting-line';
        msg.textContent = '';
        greetingEl.appendChild(msg);

        const foot = document.createElement('div');
        foot.className = 'footer';
        foot.textContent = 'your favorite senior, probably';
        greetingEl.appendChild(foot);

        output.appendChild(greetingEl);
        scrollToBottom();

        // start cycling jokes between header and footer
        let j = 0;
        function cycle(){
          // always show the header and footer; only replace msg text
          msg.textContent = jokes[j].replace('RECIPIENT_NAME', NAME);
          j = (j + 1) % jokes.length;
          setTimeout(cycle, 3000);
        }
        cycle();
      }
    }

    // read personalization params and start
    (function(){
      const params = new URLSearchParams(location.search);
      const name = params.get('name');
      const age = params.get('age');
      if(name){ NAME = name; }
      if(age){
        const n = parseInt(age,10);
        AGE = Number.isFinite(n) ? n : age;
      }

      // build commands with current NAME/AGE
      cmds = buildCommands();

      // substitute placeholders on initial command results
      cmds.forEach(c => {
        if(typeof c.res === 'string'){
          c.res = c.res.replace(/RECIPIENT_NAME/g, NAME).replace(/AGE/g, AGE);
        }
      });

      // kick off
      runNext();
    })();
  </script>
</body>
</html>
